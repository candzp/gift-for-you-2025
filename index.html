<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Holiday Gift üéÅ</title>

  <style>
    body{
      margin:0;min-height:100vh;
      display:grid;place-items:center;
      background: radial-gradient(1200px 600px at 20% 10%, #fff 0%, #f6f3ee 55%, #efe9df 100%);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
    }

    /* Emoji confetti layer */
    .emoji-confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .emoji-confetti span{
      position:absolute;
      top:-10vh;
      font-size:22px;
      opacity:.55;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.10));
      user-select:none;
      will-change: transform;
    }
    @media (prefers-reduced-motion: reduce){
      .emoji-confetti span{ display:none !important; }
    }

    .card{
      position:relative;
      z-index:1;
      width:min(680px,92vw);
      background:#fff;
      border-radius:20px;
      box-shadow:0 18px 50px rgba(0,0,0,.12);
      padding:24px;
      border:1px solid rgba(0,0,0,.06);
    }
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{margin:0 0 6px;font-size:28px;letter-spacing:.2px}
    h2{margin:18px 0 8px;font-size:18px}
    p{line-height:1.45;margin:8px 0}
    .tag{opacity:.7;font-size:14px;margin-bottom:10px}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      background:#f2f2f2;
      font-size:13px;
      white-space:nowrap;
      border:1px solid rgba(0,0,0,.05);
    }
    .badge b{font-weight:750}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    input{
      padding:12px 14px;border-radius:12px;border:1px solid #ddd;
      font-size:16px;flex:1;min-width:180px
    }
    button,a.btn{
      border:0;border-radius:12px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    button{background:#1f7a55;color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    a.btn.secondary{background:#444;color:#fff}

    .btn-ghost{
      background: rgba(0,0,0,.06);
      color: #111;
      border: 1px solid rgba(0,0,0,.08);
    }

    .code{
      margin:14px 0 6px;
      padding:14px;
      border-radius:12px;
      background:#f2f2f2;
      font:650 16px ui-monospace,monospace;
      word-break:break-all
    }
    .muted{font-size:13px;opacity:.75;line-height:1.4}
    .steps{
      background:#fafafa;border-radius:12px;padding:14px;font-size:14px;
      border:1px solid rgba(0,0,0,.05);
    }
    .steps ol{padding-left:18px;margin:8px 0}
    .steps li{margin:6px 0}
    .hidden{display:none}
    .error{margin-top:10px;color:#b00020;font-size:13px}
    .divider{height:1px;background:#eee;margin:16px 0}
    .ps{font-style:italic;font-size:14px}

    .notice{
      margin-top:10px;
      padding:12px 14px;
      border-radius:12px;
      background: rgba(31,122,85,.08);
      border: 1px solid rgba(31,122,85,.18);
      font-size:14px;
    }

    /* Scanner modal (A+B) */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:5;
      padding: 16px;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width:min(720px, 96vw);
      background:#fff;
      border-radius:18px;
      box-shadow:0 24px 80px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 16px;
      background: rgba(0,0,0,.03);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .modal-title{
      font-weight:800;
      font-size:14px;
    }
    .modal-body{
      padding:14px 16px 16px;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 0 16px 16px;
    }
    .close-btn{
      background: rgba(0,0,0,.08);
      color:#111;
      border: 1px solid rgba(0,0,0,.10);
    }

    .scan-frame{
      border-radius:14px;
      overflow:hidden;
      background: #000;
      border: 1px solid rgba(0,0,0,.12);
      position:relative;
    }
    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .scan-overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .scan-box{
      width:min(320px, 70%);
      aspect-ratio:1/1;
      border-radius:18px;
      border: 3px solid rgba(255,255,255,.65);
      box-shadow: 0 0 0 999px rgba(0,0,0,.22) inset;
    }

    .scan-status{
      margin-top:10px;
      font-size:13px;
      opacity:.8;
    }

    .tips{
      margin-top:12px;
      padding:12px 14px;
      border-radius:12px;
      background: rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.06);
      font-size:13px;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="emoji-confetti" id="emojiConfetti" aria-hidden="true"></div>

  <main class="card">
    <div class="top">
      <div>
        <h1>Season‚Äôs Greetings ‚ú®</h1>
        <div class="tag">Congratulations! You‚Äôve received a special digital gift code from me.</div>
      </div>
      <div class="badge" title="Helps you know if this is your first or second QR.">
        üéÅ <b>Gift Code</b> <span id="codeNum">#?</span>
      </div>
    </div>

    <p>Happy Holidays and Happy New Year! Here‚Äôs a little gift for you üéâ</p>

    <!-- UNLOCK SECTION (hidden after success) -->
    <div id="unlockSection">
      <h2>Unlock your code</h2>
      <div class="row">
        <input id="pin" inputmode="numeric" placeholder="Enter your PIN" />
        <button id="unlockBtn">Unlock ‚ú®</button>
      </div>
      <p class="muted">
        Your QR contains an <b>encrypted</b> gift code. The PIN unlocks it on your device.
      </p>
      <div id="err" class="error"></div>
    </div>

    <!-- REVEAL SECTION -->
    <div id="reveal" class="hidden">
      <div class="code" id="giftCode">‚Äî</div>
      <p class="muted">Expiry: <b>10/01/2045</b></p>

      <div class="row">
        <button id="copyBtn">Copy code üìã</button>
        <a class="btn secondary"
           href="https://play.google.com/store/apps/details?id=com.lazada.android"
           target="_blank" rel="noreferrer">
           Get Lazada App (Android)
        </a>
      </div>

      <p class="muted">
        iPhone / iPad: open the App Store and search <b>‚ÄúLazada‚Äù</b>.
      </p>

      <div class="notice" id="nextHint"></div>

      <!-- A + B: Scan next QR -->
      <div class="row" id="scanRow" style="margin-top:12px;">
        <button id="scanBtn">Scan next QR üì∑</button>
        <button class="btn-ghost" id="howBtn" type="button">How to scan</button>
      </div>

      <div class="divider"></div>

      <h2>How to redeem in the Lazada app üéÅ</h2>
      <div class="steps">
        <ol>
          <li>Open the <b>Lazada app</b> and log in.</li>
          <li>Go to the <b>Account</b> tab.</li>
          <li>Select <b>Lazada Wallet</b>.</li>
          <li>Tap <b>Gift Card</b>.</li>
          <li>Paste the code and tap <b>Redeem</b>.</li>
        </ol>
        <p class="muted">
          You have <b>two gift codes</b> ‚Äî scan your other QR to unlock the second one.
        </p>
      </div>

      <div class="divider"></div>

      <h2>P.S.</h2>
      <div class="steps">
        <p class="ps">If you run into issues, contact me üì´</p>
      </div>
    </div>
  </main>

  <!-- Scanner / instructions modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Scan your next gift QR</div>
        <button class="close-btn" id="closeModal" type="button">Close</button>
      </div>

      <div class="modal-body">
        <!-- B: In-browser scanner (best effort) -->
        <div id="scannerArea">
          <div class="scan-frame">
            <video id="video" playsinline muted></video>
            <div class="scan-overlay"><div class="scan-box"></div></div>
          </div>
          <div class="scan-status" id="scanStatus">Starting camera‚Ä¶</div>
        </div>

        <!-- A: Always-works instructions -->
        <div class="tips" id="tips">
          <b>If scanning doesn‚Äôt start:</b><br>
          1) Close this popup.<br>
          2) Open your phone <b>Camera</b> app.<br>
          3) Point at the other QR and tap the link.<br><br>
          Tip: Your second QR will open the same page and you‚Äôll enter the <b>same PIN</b>.
        </div>
      </div>

      <div class="modal-actions">
        <button id="startScan" type="button">Start camera scan</button>
        <button class="btn-ghost" id="stopScan" type="button">Stop</button>
      </div>
    </div>
  </div>

<script>
  // --- Emoji confetti (neutral celebration) ---
  (function makeEmojiConfetti(){
    const holder = document.getElementById("emojiConfetti");
    const emojis = ["üéÜ","üéá","üéâ","üéä","‚ú®","üí´","‚≠êÔ∏è","üíñ","ü•≥","üß®","ü™©"];
    const count = 28;

    for(let i=0;i<count;i++){
      const e = document.createElement("span");
      e.textContent = emojis[Math.floor(Math.random()*emojis.length)];

      const dur = 7 + Math.random()*7;           // seconds
      const delay = -Math.random()*10;           // start mid-animation
      const size = 16 + Math.random()*16;        // px
      const drift = (Math.random()*2 - 1) * 140; // px drift
      const left = Math.random()*100;            // vw

      e.style.left = left + "vw";
      e.style.fontSize = size + "px";
      e.style.opacity = (0.35 + Math.random()*0.45).toFixed(2);

      holder.appendChild(e);

      try{
        e.animate(
          [
            { transform: "translate(0, -12vh) rotate(0deg)" },
            { transform: `translate(${drift}px, 112vh) rotate(360deg)` }
          ],
          { duration: dur*1000, iterations: Infinity, easing: "linear", delay: delay*1000 }
        );
      }catch{
        // no-op
      }
    }
  })();

  // --- Gift unlock logic (Option B + Demo logic, but no UI hints) ---
  const rawFrag = (location.hash || "").slice(1);

  // Demo still works silently:
  // Use #demo&n=1 and PIN 123456
  const DEMO_PIN = "123456";
  const DEMO_CODE = "TEST-CODE-XXXX-XXXX";

  const unlockSection = document.getElementById("unlockSection");
  const errEl = document.getElementById("err");
  const reveal = document.getElementById("reveal");
  const codeEl = document.getElementById("giftCode");
  const pinEl = document.getElementById("pin");
  const unlockBtn = document.getElementById("unlockBtn");
  const codeNumEl = document.getElementById("codeNum");
  const nextHint = document.getElementById("nextHint");

  function parseFrag(f){
    let encPart = f;
    let n = "";
    const m = f.match(/&n=(\d+)/);
    if (m) n = m[1];
    encPart = f.split("&n=")[0];
    return { encPart, n };
  }

  const parsed = parseFrag(rawFrag);
  codeNumEl.textContent = parsed.n ? `#${parsed.n}` : "#?";

  function setNextHint(){
    const n = parsed.n;
    if (n === "1") {
      nextHint.innerHTML = "‚úÖ You unlocked <b>Gift Code #1</b>. Next: scan your <b>Gift Code #2</b> QR to unlock the second code.";
    } else if (n === "2") {
      nextHint.innerHTML = "‚úÖ You unlocked <b>Gift Code #2</b>. Next: scan your <b>Gift Code #1</b> QR if you haven‚Äôt redeemed it yet.";
    } else {
      nextHint.innerHTML = "‚úÖ Code unlocked. If you have a second gift QR, scan it to unlock your other code.";
    }
  }

  // Copy button
  const copyBtn = document.getElementById("copyBtn");
  copyBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(codeEl.textContent);
      copyBtn.textContent = "Copied ‚úì";
      setTimeout(()=>copyBtn.textContent="Copy code üìã",1500);
    } catch {
      alert("Copy failed. You can manually select and copy the code.");
    }
  };

  function b64urlToBytes(s){
    s = s.replace(/-/g,'+').replace(/_/g,'/');
    while (s.length % 4) s += '=';
    const bin = atob(s);
    const out = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
    return out;
  }

  async function deriveKey(pin, saltBytes){
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pin), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      { name:"PBKDF2", salt:saltBytes, iterations:150000, hash:"SHA-256" },
      keyMaterial,
      { name:"AES-GCM", length:256 },
      false,
      ["decrypt"]
    );
  }

  async function decryptWithPin(pin){
    const encFrag = parsed.encPart;

    if(!encFrag.startsWith("enc.")) throw new Error("Invalid QR data. Please scan the QR code again.");
    const parts = encFrag.split(".");
    if(parts.length !== 4) throw new Error("Invalid QR data format. Please scan the QR code again.");

    const salt = b64urlToBytes(parts[1]);
    const iv   = b64urlToBytes(parts[2]);
    const ct   = b64urlToBytes(parts[3]);

    const key = await deriveKey(pin, salt);
    const ptBuf = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, ct);
    return new TextDecoder().decode(ptBuf);
  }

  function clearUrlFragment(){
    try { history.replaceState(null, "", location.pathname + location.search); } catch {}
  }

  unlockBtn.onclick = async () => {
    errEl.textContent = "";
    try{
      const pin = pinEl.value.trim();
      if(!pin) throw new Error("Please enter your PIN.");
      if(!rawFrag) throw new Error("No encrypted data found. Please scan the QR code again.");

      unlockBtn.disabled = true;

      // Silent demo mode
      if (parsed.encPart === "demo"){
        if (pin !== DEMO_PIN) throw new Error("Incorrect PIN. Please try again.");
        codeEl.textContent = DEMO_CODE;
      } else {
        const code = await decryptWithPin(pin);
        codeEl.textContent = code;
      }

      unlockSection.classList.add("hidden");
      setNextHint();
      reveal.classList.remove("hidden");

      pinEl.value = "";
      clearUrlFragment();
    }catch(e){
      errEl.textContent = e.message || String(e);
      alert("Could not unlock. Please check your PIN and try again.");
    } finally {
      unlockBtn.disabled = false;
    }
  };

  // --- A + B: QR scanning modal ---
  const modal = document.getElementById("modal");
  const scanBtn = document.getElementById("scanBtn");
  const howBtn = document.getElementById("howBtn");
  const closeModal = document.getElementById("closeModal");
  const startScanBtn = document.getElementById("startScan");
  const stopScanBtn = document.getElementById("stopScan");

  const scanStatus = document.getElementById("scanStatus");
  const video = document.getElementById("video");

  let stream = null;
  let detector = null;
  let scanning = false;
  let scanLoopHandle = null;

  function openModal(){
    modal.classList.add("show");
    scanStatus.textContent = "Starting camera‚Ä¶";
  }
  function hideModal(){
    modal.classList.remove("show");
    stopScan();
  }

  closeModal.onclick = hideModal;
  modal.addEventListener("click", (e) => {
    if(e.target === modal) hideModal();
  });

  howBtn.onclick = () => { openModal(); /* do not auto-start */ };
  scanBtn.onclick = () => { openModal(); startScan().catch(()=>{}); };

  startScanBtn.onclick = () => startScan().catch(()=>{});
  stopScanBtn.onclick = stopScan;

  async function startScan(){
    if (scanning) return;

    if (!("mediaDevices" in navigator) || !navigator.mediaDevices.getUserMedia) {
      scanStatus.textContent = "Camera not available in this browser. Use your phone camera app to scan the QR.";
      return;
    }
    if (!("BarcodeDetector" in window)) {
      scanStatus.textContent = "In-page QR scanning not supported here. Use your phone camera app to scan the QR.";
      return;
    }

    try{
      detector = new BarcodeDetector({ formats: ["qr_code"] });
    }catch{
      scanStatus.textContent = "Scanner unavailable. Use your phone camera app to scan the QR.";
      return;
    }

    scanStatus.textContent = "Requesting camera permission‚Ä¶";

    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();

      scanning = true;
      scanStatus.textContent = "Point the camera at the other QR‚Ä¶";
      scanLoop();
    }catch{
      scanStatus.textContent = "Could not start camera. Use your phone camera app to scan the QR.";
      stopScan();
    }
  }

  function scanLoop(){
    if (!scanning) return;

    scanLoopHandle = requestAnimationFrame(async () => {
      try{
        if (video.readyState >= 2 && detector){
          const barcodes = await detector.detect(video);
          if (barcodes && barcodes.length){
            const value = barcodes[0].rawValue || "";
            if (value.startsWith("http://") || value.startsWith("https://")) {
              scanStatus.textContent = "QR detected! Opening‚Ä¶";
              stopScan();
              location.href = value;
              return;
            } else {
              scanStatus.textContent = "QR detected, but it doesn‚Äôt look like a link.";
            }
          }
        }
      }catch{
        // ignore and keep scanning
      }
      scanLoop();
    });
  }

  function stopScan(){
    scanning = false;
    if (scanLoopHandle) cancelAnimationFrame(scanLoopHandle);
    scanLoopHandle = null;

    try{ video.pause(); }catch{}
    video.srcObject = null;

    if (stream){
      try{ stream.getTracks().forEach(t => t.stop()); }catch{}
      stream = null;
    }
    detector = null;

    scanStatus.textContent = "Camera stopped. You can scan using your phone camera app anytime.";
  }
</script>
</body>
</html>
